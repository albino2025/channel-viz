<!doctype>

<link rel="stylesheet" href="css/rickshaw.min.css">


<script src="js/d3.v2.js"></script>
<script src="js/rickshaw2.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>  
<script src="js/xivelyjs-1.0.0.min.js"></script>  

<style>
#chart_container {
        position: relative;
        display: inline-block;
        font-family: Arial, Helvetica, sans-serif;
}
#y_axis {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
}
#chart {
        display: inline-block;
        margin-left: 40px;
}
#legend {
        display: inline-block;
        vertical-align: top;
        margin: 0 0 0 10px;
}


</style>


<div id="chart_container">
	<div id="y_axis"></div><div id="chart"></div>
</div>
<div id="legend"></div>

<script>

// Make sure the document is ready to be handled  
$(document).ready(function($) {  


	// Set the Xively API key  
	xively.setKey( "Gr5aw0GOFcyEm4IsoAN0VDLJFeHYn9CBd8XOFtE6jxkOD5pC" );
      
      
	// Replace with your own values  
        var feedID        = 172663481, // Feed ID  
        datastreamID  = "Chauffage_Buanderie",
        val_x = 0,
	val_y = 0,
	points = [],
	serie_temp_reelle = [],
	serie_status_chauffage = [],
	serie_temp_voulue = [];       // Datastream ID  

	xively.feed.history(feedID, {duration: '6hours', interval: 30, limit: 1000}, function(feedData) {
      
        feedData.datastreams.forEach(function(datastreamData) {

			if (datastreamData.id == "Chauffage_Buanderie") {
				
				var i = 0;
				
				datastreamData.datapoints.forEach(function(datapoint) {
					val_x = new Date(datapoint.at).getTime()/1000.0;
					val_y = parseFloat(datapoint.value)*10;
					if (i > 0) {
						serie_status_chauffage.push({x : (val_x-1), y: (serie_status_chauffage[serie_status_chauffage.length-1].y)});
					}
                  			serie_status_chauffage.push({x: val_x, y: val_y});
					i=i+1;
				});
          
				val_x = Date.now()/1000.0;
				serie_status_chauffage.push({x : val_x, y: (serie_status_chauffage[serie_status_chauffage.length-1].y)});
			}
			
			if (datastreamData.id == "Temp_buanderie") {
				
				datastreamData.datapoints.forEach(function(datapoint) {
					val_x = new Date(datapoint.at).getTime()/1000.0;
					val_y = parseFloat(datapoint.value);
                  			serie_temp_reelle.push({x: val_x, y: val_y});
				});
			}
			
			if (datastreamData.id == "Temp_cible_buanderie") {
				
				datastreamData.datapoints.forEach(function(datapoint) {
					val_x = new Date(datapoint.at).getTime()/1000.0;
					val_y = parseFloat(datapoint.value);
                  			serie_temp_voulue.push({x: val_x, y: val_y});
				});
			}
        });
		
		var graph = new Rickshaw.Graph( {
			element: document.querySelector("#chart"),
			width: 580,
			height: 250,
			renderer: 'multi',
			//renderer: 'area',
			interpolation: 'straight',
			unstack : true,
			stroke: true,
			series: [ {
				color: 'rgba(70,130,180,0.5)',
				stroke: 'rgba(0,0,0,0.15)',
				name: 'statut chauffage',
				renderer: 'area',
				data: serie_status_chauffage
			},{
				color: 'rgba(202,226,247,0.5)',
				stroke: 'rgba(0,0,0,0.15)',
				name: 'temperature',
				renderer: 'line',
				data: serie_temp_reelle
			},{
				color: 'rgba(255,0,0,1)',
				stroke: 'rgba(0,0,0,0.15)',
				renderer: 'line',
				name: 'consigne',
				data: serie_temp_voulue
			}]
		});
    	graph.render();
				

		// ATTENTION, la suite necessite le css
            
		// affiche les valeurs x et y du point survolé 
		var hoverDetail = new Rickshaw.Graph.HoverDetail( {
        	graph: graph
		});
            
				
		//affiche la legende dans la div legend
		var legend = new Rickshaw.Graph.Legend( {
			graph: graph,
			element: document.getElementById('legend')
		});
			
            
		//permet de selectionner / deselectionner les series à afficher
		var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
			graph: graph,
			legend: legend
		});
            
		// surligne le graph correspondant à la legende survolee
		var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
			graph: graph,
			legend: legend
		});
	    
		// Add a basic x-axis with time values:
		var xAxis = new Rickshaw.Graph.Axis.Time({
			graph: graph
		});
		xAxis.render();
	    
		var y_axis = new Rickshaw.Graph.Axis.Y( {
			graph: graph,
			orientation: 'left',
			tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
			element: document.getElementById('y_axis'),
		});
		y_axis.render();
			
	});
	
});	
</script>
